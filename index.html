<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>淑芸催討囉~</title>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --card:#111f3a;
      --text:#e8eefc; --muted:#a9b6d6; --line:rgba(255,255,255,.10);
      --accent:#7c5cff; --accent2:#25d0ab; --warn:#ffcc66; --danger:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff;
        --text:#101828; --muted:#475467; --line:rgba(16,24,40,.10);
        --shadow: 0 18px 60px rgba(16,24,40,.12);
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
        "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.20), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(37,208,171,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}

    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 60px}
    header{
      background: linear-gradient(135deg, rgba(124,92,255,.18), rgba(37,208,171,.12));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:22px 22px 18px;
      backdrop-filter: blur(10px);
    }
    .titleRow{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:22px; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.4;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .controls{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.6fr .7fr .9fr;
      gap:10px;
    }
    @media (max-width: 900px){ .controls{grid-template-columns: 1fr 1fr;} }
    @media (max-width: 520px){ .controls{grid-template-columns: 1fr;} }

    .control{
      display:flex; align-items:center; gap:10px;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      position: relative;
    }
    .control input, .control select{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .control input::placeholder{
      color: color-mix(in srgb, var(--muted) 80%, transparent);
    }
    .icon{
      width:18px; height:18px; opacity:.9; flex:0 0 auto;
      color: color-mix(in srgb, var(--muted) 70%, var(--text));
    }

    main{margin-top:18px}
    .metaRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      color:var(--muted);
      font-size:12px;
      margin:12px 4px 10px;
      flex-wrap:wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
    }
    @media (max-width: 860px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
      min-height: 190px;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 200px at 10% 0%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(600px 200px at 90% 0%, rgba(37,208,171,.14), transparent 60%);
      pointer-events:none;
    }
    .cardInner{
      position:relative;
      padding:16px 16px 14px;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .unit{font-size:12px; color:var(--muted); margin:0 0 6px;}
    .jobTitle{margin:0; font-size:16px; line-height:1.35; letter-spacing:.2px;}

    .tags{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .tag.urgent{color: var(--warn); border-color: color-mix(in srgb, var(--warn) 40%, var(--line));}
    .tag.danger{color: var(--danger); border-color: color-mix(in srgb, var(--danger) 45%, var(--line));}
    .tag.ok{color: var(--accent2); border-color: color-mix(in srgb, var(--accent2) 45%, var(--line));}

    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
    }

    .btnRow{
      margin-top:auto; /* ✅ 固定到底部 */
      display:flex;
      justify-content:flex-end; /* ✅ 右下角 */
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: linear-gradient(135deg, rgba(124,92,255,.25), rgba(37,208,171,.15));
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.05);}
    .btn[aria-disabled="true"]{
      opacity:.55;
      cursor:not-allowed;
      filter: none;
    }

    .empty{
      padding:18px;
      border:1px dashed var(--line);
      border-radius: var(--radius);
      color:var(--muted);
      background: rgba(255,255,255,.03);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }

    /* 深色系 select 展開選單（避免白底刺眼） */
    .control select{
      background-color: transparent;
      color: var(--text);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 34px; /* 留給箭頭 */
      cursor: pointer;
    }
    .control:has(select)::after{
      content:"";
      position:absolute;
      right:14px;
      top:50%;
      width:8px;
      height:8px;
      transform: translateY(-50%) rotate(45deg);
      border-right: 2px solid color-mix(in srgb, var(--muted) 80%, transparent);
      border-bottom: 2px solid color-mix(in srgb, var(--muted) 80%, transparent);
      pointer-events:none;
      opacity:.9;
    }
    select option{
      background-color: var(--panel);
      color: var(--text);
    }
    select option:checked{
      background-color: color-mix(in srgb, var(--accent) 25%, var(--panel));
      color: var(--text);
    }

    /* Pagination */
    .pager{
      margin-top:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .pageBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
      min-width:40px;
      text-align:center;
      transition: transform .12s ease, filter .12s ease;
    }
    .pageBtn:hover{transform: translateY(-1px); filter: brightness(1.05);}
    .pageBtn[disabled]{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
      filter:none;
    }
    .pageBtn.active{
      background: linear-gradient(135deg, rgba(124,92,255,.28), rgba(37,208,171,.18));
      border-color: color-mix(in srgb, var(--accent) 40%, var(--line));
      font-weight:700;
    }
  
    /* Date separator (group by 公告日) */
    .dateSep{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 6px 2px 2px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .dateSep strong{color: var(--text); font-size:13px;}
    .dateSep .newBadge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(37,208,171,.12));
      color: var(--text);
      white-space:nowrap;
    }

    /* 收藏 */
    .btnRow{
      justify-content:space-between; /* 左收藏 右查看 */
      gap:10px;
    }
    .favBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
      user-select:none;
    }
    .favBtn:hover{transform: translateY(-1px); filter: brightness(1.05);}
    .favBtn[aria-pressed="true"]{
      background: linear-gradient(135deg, rgba(255,204,102,.22), rgba(124,92,255,.14));
      border-color: color-mix(in srgb, var(--warn) 45%, var(--line));
    }
    .favBtn .star{font-size:14px; line-height:1;}
    .favToggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .favToggle input{accent-color: var(--accent);}

  
      .selectWrap{display:flex; flex-direction:column; gap:6px; min-width: 180px;}
.hint{font-size:12px; color: rgba(255,255,255,.65); line-height:1.2;}

/* 多選下拉（保留原本點開的操作感） */
.multiWrap{position:relative; width:100%; min-width: 180px;}
.multiTrigger{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:14px 14px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--text);
  font-size:14px;
  cursor:pointer;
}
.multiTrigger:hover{background: rgba(255,255,255,.05);}
.multiTrigger:focus{outline:2px solid rgba(122, 92, 255, .35); outline-offset:2px;}
.multiTrigger .chev{width:18px; height:18px; opacity:.85;}

.multiDropdown{
  position:absolute;
  left:0; right:0;
  top: calc(100% + 8px);
  z-index: 50;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(16, 22, 40, .96);
  backdrop-filter: blur(14px);
  box-shadow: 0 18px 50px rgba(0,0,0,.45);
  padding:10px;
}
.multiList{
  max-height: 240px;
  overflow:auto;
  padding:6px 6px;
}
.multiItem{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  border-radius:12px;
  cursor:pointer;
  user-select:none;
}
.multiItem:hover{background: rgba(255,255,255,.06);}
.multiItem input{accent-color: var(--accent);}
.multiItem span{font-size:14px; color: rgba(255,255,255,.92);}
.multiActions{
  display:flex;
  gap:8px;
  padding:8px 6px 4px;
  border-top:1px solid rgba(255,255,255,.08);
  margin-top:6px;
}
.miniBtn{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.9);
  cursor:pointer;
  font-size:13px;
}
.miniBtn:hover{background: rgba(255,255,255,.07);}
    </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="titleRow">
        <div>
          <h1>淑芸催討囉~</h1>
          <p class="sub">支援搜尋、縣市（可複選）/截止期限篩選；預設依公告日由新到舊排序。</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          <div class="pill" id="summaryPill">載入中…</div>
          <div class="pill" id="modifiedPill" style="display:none;">更新：—</div>
        </div>
      </div>

      <div class="controls">
        <div class="control">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M21 21l-4.35-4.35m1.35-5.15a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="q" placeholder="搜尋：機關、職缺標題、地點…" autocomplete="off" />
        </div>

        <div class="control">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 11a2 2 0 100-4 2 2 0 000 4z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <div class="multiWrap" id="cityMulti">
  <button type="button" class="multiTrigger" id="cityTrigger" aria-haspopup="listbox" aria-expanded="false">
    全部縣市
    <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  <div class="multiDropdown" id="cityDropdown" role="listbox" aria-label="縣市（可複選）" hidden>
    <div class="multiList" id="cityOptions"></div>
    <div class="multiActions">
      <button type="button" class="miniBtn" id="cityAllBtn">全選</button>
      <button type="button" class="miniBtn" id="cityClearBtn">清除</button>
    </div>
  </div>
</div>
        </div>

        <div class="control">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M7 2v3M17 2v3M3.5 7h17M5 10h14M6 14h4M6 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M4 5h16a2 2 0 012 2v13a2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2z" stroke="currentColor" stroke-width="2" opacity=".35"/>
          </svg>
          <select id="deadlineFilter">
            <option value="">全部期限</option>
            <option value="7">一週內截止</option>
            <option value="30">一個月內截止</option>
            <option value="60">兩個月內截止</option>
            <option value="90">三個月內截止</option>
            <option value="open">尚未截止</option>
            <option value="overdue">已截止</option>
          </select>
        </div>
      </div>

      <div class="metaRow">
        <div>小技巧：在搜尋框按 <span class="kbd">/</span> 可快速聚焦。</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          <label class="favToggle" title="收藏會儲存在此瀏覽器（不需登入）">
            <input type="checkbox" id="onlyFav" /> 只看收藏
          </label>
          <div id="countText"></div>
        </div>
      </div>
    </header>

    <main>
      <div class="grid" id="list"></div>

      <div class="pager" id="pager" style="display:none;"></div>

      <div class="empty" id="empty" style="display:none;">
        找不到符合條件的資料，試試看清除篩選或換個關鍵字。
      </div>
    </main>
  </div>

  <script>
    let DATA = [];
    const PAGE_SIZE = 12;
    const FAV_KEY = 'job_favorites_v1';
    let FAVORITES = new Set();
    let dataLastModifiedText = '';
    let dataFetchedAtText = '';
    let onlyFav = false;

    function loadFavorites(){
      try{
        const raw = localStorage.getItem(FAV_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        FAVORITES = new Set(Array.isArray(arr) ? arr : []);
      }catch(e){
        FAVORITES = new Set();
      }
    }
    function saveFavorites(){
      try{ localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(FAVORITES))); }catch(e){}
    }
    function jobKey(x){
      const u = cleanUrl(x.linkUrl);
      if(u) return `url:${u}`;
      // fallback (rare)
      return `t:${fmt(x.unit)}|${fmt(x.title)}|${fmt(x.postDate)}|${fmt(x.deadline)}|${fmt(x.location)}`;
    }

    function formatDateTime(dt){
      try{
        return new Intl.DateTimeFormat('zh-TW', {
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', hour12:false
        }).format(dt);
      }catch(e){
        return dt.toISOString();
      }
    }

    function postDateLabel(s){
      const d = parseYMD(s);
      if(!d) return fmt(s) || '—';
      return new Intl.DateTimeFormat('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit'}).format(d);
    }

    function newestPostDate(items){
      let max = 0;
      for(const x of items){
        const t = parseYMD(x.postDate)?.getTime() ?? 0;
        if(t>max) max=t;
      }
      return max;
    }

    
    let currentPage = 1;

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const fmt = (s) => (s ?? "").toString().trim();

    function parseYMD(s){
      const t = fmt(s).replace(/-/g, "/");
      const [y,m,d] = t.split("/").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }

    function daysUntil(date){
      if(!date) return null;
      const now = new Date();
      const a = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const b = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      return Math.round((b - a) / 86400000);
    }

    function cleanUrl(u){
      const s = fmt(u);
      if(!s) return "";
      return s.split(/\s+"/)[0].trim();
    }

    function uniq(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
    }

    function normalizeZhTW(s){
      // 常見：台 -> 臺（用於縣市一致性）
      return fmt(s).replaceAll("台","臺");
    }

    // 臺灣常見縣市排序（由北到南＋東部＋離島）
    const CITY_ORDER = [
      "臺北市","新北市","基隆市","桃園市",
      "新竹市","新竹縣","苗栗縣",
      "臺中市","彰化縣","南投縣","雲林縣",
      "嘉義市","嘉義縣","臺南市","高雄市","屏東縣",
      "宜蘭縣","花蓮縣","臺東縣",
      "澎湖縣","金門縣","連江縣"
    ];

    function sortCitiesZhTW(list){
      return [...list].sort((a,b)=>{
        const A = normalizeZhTW(a);
        const B = normalizeZhTW(b);
        const ia = CITY_ORDER.indexOf(A);
        const ib = CITY_ORDER.indexOf(B);
        if(ia !== -1 || ib !== -1){
          return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
        }
        return A.localeCompare(B, "zh-Hant");
      });
    }


    function cityFromLocation(location){
      const s = normalizeZhTW(location);
      const cities = [
        "臺北市","新北市","桃園市","臺中市","臺南市","高雄市",
        "基隆市","新竹市","嘉義市",
        "新竹縣","苗栗縣","彰化縣","南投縣","雲林縣","嘉義縣",
        "屏東縣","宜蘭縣","花蓮縣","臺東縣","澎湖縣","金門縣","連江縣"
      ];
      for(const c of cities){
        if(s.includes(c)) return c;
      }
      // 若資料本身就是縣市/國外等，至少回傳第一段
      // 例如「高雄市燕巢區」→高雄市；「臺灣」→臺灣
      const m = s.match(/^(..市|..縣)/);
      if(m) return m[0];
      return s ? s.split(/[\s,，]/)[0] : "";
    }

    function badgeForDeadline(deadlineStr){
      const d = parseYMD(deadlineStr);
      const left = daysUntil(d);
      if(left === null) return {text:"未提供截止日", cls:""};
      if(left < 0) return {text:`已截止（${Math.abs(left)} 天前）`, cls:"danger"};
      if(left === 0) return {text:"今天截止", cls:"danger"};
      if(left <= 7) return {text:`剩 ${left} 天`, cls:"urgent"};
      return {text:`剩 ${left} 天`, cls:"ok"};
    }

    function escapeHtml(str){
      return fmt(str)
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== UI =====
    const q = $("#q");
    const cityTrigger = $("#cityTrigger");
    const cityDropdown = $("#cityDropdown");
    const cityOptions = $("#cityOptions");
    const cityAllBtn = $("#cityAllBtn");
    const cityClearBtn = $("#cityClearBtn");

    let selectedCitySet = new Set();
    const ddlSel = $("#deadlineFilter");
    const list = $("#list");
    const empty = $("#empty");
    const pager = $("#pager");
    const countText = $("#countText");
    const summaryPill = $("#summaryPill");
    const modifiedPill = $("#modifiedPill");
    const onlyFavChk = $("#onlyFav");

    function updateCityTriggerText(){
      if(!cityTrigger) return;
      const arr = Array.from(selectedCitySet);
      // cityTrigger 內第一段文字節點是標籤文字（後面還有小箭頭 SVG）
      if(arr.length === 0){
        cityTrigger.childNodes[0].nodeValue = "全部縣市";
      }else if(arr.length === 1){
        cityTrigger.childNodes[0].nodeValue = arr[0];
      }else{
        cityTrigger.childNodes[0].nodeValue = `已選 ${arr.length} 個縣市`;
      }
    }

    function openCityDropdown(){
      if(!cityDropdown || !cityTrigger) return;
      cityDropdown.hidden = false;
      cityTrigger.setAttribute("aria-expanded","true");
    }
    function closeCityDropdown(){
      if(!cityDropdown || !cityTrigger) return;
      cityDropdown.hidden = true;
      cityTrigger.setAttribute("aria-expanded","false");
    }
    function toggleCityDropdown(){
      if(!cityDropdown) return;
      if(cityDropdown.hidden) openCityDropdown();
      else closeCityDropdown();
    }

    function initFilters(){
      const cities = sortCitiesZhTW(uniq(DATA.map(x => cityFromLocation(x.location))));

      // 產生「可複選」的自訂下拉（點開才顯示，不會一開始展開）
      cityOptions.innerHTML = cities.map((v, i) => {
        const id = `cityOpt_${i}`;
        return `
          <label class="multiItem" for="${id}">
            <input id="${id}" type="checkbox" value="${escapeHtml(v)}" />
            <span>${escapeHtml(v)}</span>
          </label>
        `;
      }).join("");

      // 事件：勾選縣市
      cityOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", () => {
          const val = fmt(cb.value);
          if(cb.checked) selectedCitySet.add(val);
          else selectedCitySet.delete(val);
          updateCityTriggerText();
          currentPage = 1;
          render();
        });
      });

      // 全選 / 清除
      if(cityAllBtn){
        cityAllBtn.addEventListener("click", () => {
          selectedCitySet = new Set(cities.map(v => fmt(v)));
          cityOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
          updateCityTriggerText();
          currentPage = 1;
          render();
        });
      }
      if(cityClearBtn){
        cityClearBtn.addEventListener("click", () => {
          selectedCitySet = new Set();
          cityOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          updateCityTriggerText();
          currentPage = 1;
          render();
        });
      }

      updateCityTriggerText();
summaryPill.textContent = `共 ${DATA.length} 筆資料`;

      // 顯示資料最新修改時間（若伺服器提供 Last-Modified，就用它；否則顯示本次讀取時間）
      const t = dataLastModifiedText || dataFetchedAtText;
      if(t){
        modifiedPill.style.display = 'inline-flex';
        modifiedPill.textContent = `更新：${t}`;
      }else{
        modifiedPill.style.display = 'none';
      }
    }

    function sortByPostDesc(items){
      return items.slice().sort((a,b)=>{
        const ta = parseYMD(a.postDate)?.getTime() ?? 0;
        const tb = parseYMD(b.postDate)?.getTime() ?? 0;
        return tb - ta;
      });
    }

    function matchDeadlineBucket(item){
      const mode = fmt(ddlSel.value);
      if(!mode) return true;

      const d = parseYMD(item.deadline);
      const left = daysUntil(d);

      if(mode === "open"){
        return left === null ? true : left >= 0;
      }
      if(mode === "overdue"){
        return left !== null && left < 0;
      }

      const n = Number(mode);
      if(Number.isFinite(n)){
        // 沒有截止日：放行（避免錯失資訊），你也可改成 false
        if(left === null) return true;
        return left >= 0 && left <= n;
      }
      return true;
    }

    function filterItems(){
      const keyword = fmt(q.value).toLowerCase();
      const selectedCities = Array.from(selectedCitySet);

      const filtered = DATA.filter(x => {
        const key = jobKey(x);
        if(onlyFav && !FAVORITES.has(key)) return false;
        if(selectedCities.length && !selectedCities.includes(cityFromLocation(x.location))) return false;
        if(!matchDeadlineBucket(x)) return false;

        if(!keyword) return true;

        const hay = [
          x.unit, x.title, x.location, x.postDate, x.deadline, x.linkText
        ].map(v => fmt(v).toLowerCase()).join(" | ");

        return hay.includes(keyword);
      });

      return sortByPostDesc(filtered);
    }

    function paged(items){
      const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
      if(currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * PAGE_SIZE;
      return {
        totalPages,
        pageItems: items.slice(start, start + PAGE_SIZE),
        startIndex: items.length ? start + 1 : 0,
        endIndex: items.length ? Math.min(start + PAGE_SIZE, items.length) : 0
      };
    }

    function renderPager(totalPages, totalItems){
      if(totalItems <= PAGE_SIZE){
        pager.style.display = "none";
        pager.innerHTML = "";
        return;
      }

      pager.style.display = "flex";

      const mkBtn = ({label, page, disabled=false, active=false}) => {
        const dis = disabled ? "disabled" : "";
        const act = active ? "active" : "";
        return `<button class="pageBtn ${act}" ${dis} data-page="${page}">${label}</button>`;
      };

      const buttons = [];
      buttons.push(mkBtn({label:"‹", page: Math.max(1, currentPage - 1), disabled: currentPage === 1}));

      // 顯示範圍：current ±2
      const start = Math.max(1, currentPage - 2);
      const end = Math.min(totalPages, currentPage + 2);

      if(start > 1){
        buttons.push(mkBtn({label:"1", page:1, active: currentPage===1}));
        if(start > 2) buttons.push(`<span style="opacity:.7; padding:0 4px;">…</span>`);
      }

      for(let p = start; p <= end; p++){
        buttons.push(mkBtn({label:String(p), page:p, active: p===currentPage}));
      }

      if(end < totalPages){
        if(end < totalPages - 1) buttons.push(`<span style="opacity:.7; padding:0 4px;">…</span>`);
        buttons.push(mkBtn({label:String(totalPages), page:totalPages, active: currentPage===totalPages}));
      }

      buttons.push(mkBtn({label:"›", page: Math.min(totalPages, currentPage + 1), disabled: currentPage === totalPages}));

      pager.innerHTML = buttons.join("");

      pager.querySelectorAll("button[data-page]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const p = Number(btn.getAttribute("data-page"));
          if(!p || p === currentPage) return;
          currentPage = p;
          render();
          window.scrollTo({top:0, behavior:"smooth"});
        });
      });
    }

    function render(){
      const all = filterItems();
      const { totalPages, pageItems, startIndex, endIndex } = paged(all);

      countText.textContent = all.length
        ? `顯示 ${startIndex}–${endIndex} / ${all.length} 筆（資料庫共 ${DATA.length} 筆）`
        : `顯示 0 / 0 筆（資料庫共 ${DATA.length} 筆）`;

      if(all.length === 0){
        list.innerHTML = "";
        pager.style.display = "none";
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";
      renderPager(totalPages, all.length);

      {
      const newest = newestPostDate(all);
      let lastLabel = null;
      const chunks = [];
      for(const x of pageItems){
        const postLabel = postDateLabel(x.postDate);
        const postTs = parseYMD(x.postDate)?.getTime() ?? 0;

        if(postLabel !== lastLabel){
          const isNewest = newest && postTs === newest;
          chunks.push(`
            <div class="dateSep">
              <strong>公告日：${escapeHtml(postLabel)}</strong>
              ${isNewest ? `<span class="newBadge">最新公告</span>` : ``}
            </div>
          `);
          lastLabel = postLabel;
        }

        const url = cleanUrl(x.linkUrl);
        const badge = badgeForDeadline(x.deadline);
        const post = fmt(x.postDate) || "—";
        const deadline = fmt(x.deadline) || "—";
        const city = cityFromLocation(x.location);

        chunks.push(`
          <article class="card">
            <div class="cardInner">
              <div>
                <p class="unit">${escapeHtml(fmt(x.unit) || "（未提供機關）")}</p>
                <h3 class="jobTitle">${escapeHtml(fmt(x.title) || "（未提供職缺標題）")}</h3>

                <div class="tags">
                  <span class="tag">${escapeHtml(city || "未提供縣市")}</span>
                  <span class="tag ${badge.cls}">${escapeHtml(badge.text)}</span>
                </div>

                <div class="row">
                  <span>公告日：${escapeHtml(post)}</span>
                  <span>｜</span>
                  <span>截止日：${escapeHtml(deadline)}</span>
                </div>
              </div>

              <div class="btnRow">
                <button class="favBtn" type="button" data-key="${escapeHtml(jobKey(x))}" aria-pressed="${FAVORITES.has(jobKey(x)) ? "true" : "false"}" title="收藏/取消收藏（會儲存在此瀏覽器）">
                  <span class="star">${FAVORITES.has(jobKey(x)) ? "★" : "☆"}</span>
                  <span>${FAVORITES.has(jobKey(x)) ? "已收藏" : "收藏"}</span>
                </button>
                <a class="btn" href="${escapeHtml(url || "#")}" target="_blank" rel="noreferrer noopener"
                  ${url ? "" : "aria-disabled='true' onclick='return false;'"}>
                  查看公告 <span style="opacity:.9">↗</span>
                </a>
              </div>
            </div>
          </article>
        `);
      }
      list.innerHTML = chunks.join("");
    }
    }

    function wire(){
      // 任何篩選/搜尋變更都回到第一頁
      q.addEventListener("input", ()=>{ currentPage = 1; render(); });
      // 縣市多選下拉：點一下才展開
if(cityTrigger){
  cityTrigger.addEventListener("click", (e)=>{ e.preventDefault(); toggleCityDropdown(); });
}
// 點擊外部關閉
document.addEventListener("click", (e)=>{
  const t = e.target;
  if(!cityDropdown || !cityTrigger) return;
  const inBox = cityDropdown.contains(t) || cityTrigger.contains(t);
  if(!inBox) closeCityDropdown();
});
// ESC 關閉
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeCityDropdown();
});
      ddlSel.addEventListener("change", ()=>{ currentPage = 1; render(); });

      // 只看收藏
      if(onlyFavChk){
        onlyFav = !!onlyFavChk.checked;
      }
      if(onlyFavChk){
        onlyFavChk.addEventListener('change', ()=>{ onlyFav = !!onlyFavChk.checked; currentPage = 1; render(); });
      }

      // 收藏按鈕（事件代理）
      list.addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('.favBtn');
        if(!btn) return;
        const key = btn.getAttribute('data-key');
        if(!key) return;
        if(FAVORITES.has(key)) FAVORITES.delete(key); else FAVORITES.add(key);
        saveFavorites();
        render();
      });

      // 快捷鍵：/ 聚焦搜尋
      window.addEventListener("keydown", (e) => {
        if(e.key === "/" && document.activeElement !== q){
          e.preventDefault();
          q.focus();
        }
      });
    }

    // ===== Boot =====
    async function load(){
      try{
        const res = await fetch("./data", { cache: 'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);

        const lm = res.headers.get('Last-Modified');
        if(lm){
          const d = new Date(lm);
          if(!Number.isNaN(d.getTime())) dataLastModifiedText = formatDateTime(d);
        }
        dataFetchedAtText = formatDateTime(new Date());

        DATA = await res.json();

        loadFavorites();
        initFilters();
        wire();
        render();
      }catch(err){
        console.error(err);
        summaryPill.textContent = "載入失敗";
        list.innerHTML = `
          <div class="empty">
            無法載入資料。請確認 <b>data</b> API 是否可取得 JSON 陣列（[...]）。
          </div>
        `;
      }
    }
    load();
  </script>
</body>
</html>
